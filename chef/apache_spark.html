<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Cookbook: apache_spark
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!chef/apache_spark.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../index.html">Index (a)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../chef.html" title="chef (chef)">chef</a></span></span>
     &raquo; 
    <span class="title">apache_spark</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="cookbooks_list_link"
        href="../cookbooks_list.html">
      Cookbook List
    </a>
  
    <a class="full_list_link" id="recipes_list_link"
        href="../recipes_list.html">
      Recipe List
    </a>
  
    <a class="full_list_link" id="resources_list_link"
        href="../resources_list.html">
      Resource List
    </a>
  
    <a class="full_list_link" id="definitions_list_link"
        href="../definitions_list.html">
      Definitions List
    </a>
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Libraries List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content">

<div id="filecontents">
  <h1>Cookbook : apache_spark</h1>
  

<h1>apache_spark</h1>

<p><a href="https://travis-ci.org/clearstorydata-cookbooks/apache_spark"><img src="https://travis-ci.org/clearstorydata-cookbooks/apache_spark.svg?branch=master" alt="Build Status"></a></p>

<p>This cookbook installs and configures Apache Spark.</p>

<ul>
<li>GitHub: <a href="https://github.com/clearstorydata-cookbooks/apache_spark">https://github.com/clearstorydata-cookbooks/apache_spark</a></li>
<li>Chef Supermarket: <a href="https://supermarket.chef.io/cookbooks/apache_spark">https://supermarket.chef.io/cookbooks/apache_spark</a></li>
<li>Travis CI: <a href="https://travis-ci.org/clearstorydata-cookbooks/apache_spark">https://travis-ci.org/clearstorydata-cookbooks/apache_spark</a></li>
<li>Documentation: <a href="http://clearstorydata-cookbooks.github.io/apache_spark/chef/apache_spark.html">http://clearstorydata-cookbooks.github.io/apache_spark/chef/apache_spark.html</a></li>
</ul>

<h2>Overview</h2>

<p>This cookbook installs and configures Apache Spark. Currently, only the standalone deployment mode
is supported. Future work:</p>

<ul>
<li>YARN and Mesos deployment modes</li>
<li>Support installing from Cloudera and HDP Spark packages.</li>
</ul>

<h2>Compatibility</h2>

<p>The following platforms are currently tested:</p>

<ul>
<li>Ubuntu 12.04</li>
<li>CentOS 6.5</li>
</ul>

<p>The following platforms are not tested but will probably work (tests coming soon):</p>

<ul>
<li>Fedora 21</li>
<li>Ubuntu 14.04</li>
</ul>

<h2>Configuration</h2>

<ul>
<li><code>node[&#39;apache_spark&#39;][&#39;install_mode&#39;]</code>: <code>tarball</code> to install from a downloaded tarball,
or <code>package</code> to install from an OS-specific package.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;download_url&#39;]</code>: the URL to download Apache Spark binary distribution
tarball in the <code>tarball</code> installation mode.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;checksum&#39;]</code>: SHA256 checksum for the Apache Spark binary distribution
tarball.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;pkg_name&#39;]</code>: package name to install in the <code>package</code> installation mode.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;pkg_version&#39;]</code>: package version to install in the <code>package</code> installation
mode.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;install_dir&#39;]</code>: target directory to install Spark to in the <code>tarball</code>
installation mode. In the <code>package</code> mode, this must be set to the directory that the package
installs Spark into.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;install_base_dir&#39;]</code>: in the <code>tarball</code> installation mode, this is where
the tarball is actually extracted, and a symlink pointing to the subdirectory containing a
specific Spark version is created at <code>node[&#39;apache_spark&#39;][&#39;install_dir&#39;]</code>.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;user&#39;]</code>: UNIX user to create for running Spark.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;group&#39;]</code>: UNIX group to create for running Spark.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;master_host&#39;]</code>: Spark standalone-mode workers will connect to
this host.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;master_bind_ip&#39;]</code>: the IP the master should bind to. This
should be set in such a way that workers will be able to connect to the master.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;master_port&#39;]</code>: the port for the Spark standalone master to
listen on.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;master_webui_port&#39;]</code>: Spark standalone master web UI port.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_bind_ip&#39;]</code>: the IP address workers bind to.
They bind to all network interfaces by default.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_webui_port&#39;]</code>: the port for the Spark worker web UI
to listen on.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;job_dir_days_retained&#39;]</code>: <code>app-...</code> subdirectories of
<code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_work_dir&#39;]</code> older than this number of days will be
deleted periodically on worker nodes to prevent unbounded accumulation. These directories contain
Spark executor stdout/stderr logs. The directories will still be retained to honor
<code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;job_dir_num_retained&#39;]</code>.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;job_dir_num_retained&#39;]</code>: the minimum number of Spark
executor log directories (<code>app-...</code>) to retain, regardless of creation time.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_dir_cleanup_log&#39;]</code>: log file path for the Spark
executor log directories cleanup script.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_cores&#39;]</code>: the number of &quot;cores&quot; (threads) to allocate
on each worker node.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_work_dir&#39;]</code>: the directory to store Spark
executor logs and Spark job jars.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_memory_mb&#39;]</code>: the amount of memory in MB to allocate
to each worker (i.e. the maximum total memory used by different applications&#39; executors running
on a worker node).</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;default_executor_mem_mb&#39;]</code>: the default amount of memory
to be allocated to a Spark application&#39;s executor on each node.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;log_dir&#39;]</code>: the log directory for Spark masters and workers.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;daemon_root_logger&#39;]</code>: the <code>spark.root.logger</code> property
is set to this.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;max_num_open_files&#39;]</code>: the maximum number of open files to
set using <code>ulimit</code> before launching a worker.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;java_debug_enabled&#39;]</code>: whether Java debugging options are
to be enabled for Spark processes. Note: currently, this option is not working as intended.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;default_debug_port&#39;]</code>: default Java debug port to use.
A free port is chosen if this port is unavailable.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;master_debug_port&#39;]</code>: default Java debug port to use for
Spark masters. A free port is chosen if this port is unavailable.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_debug_port&#39;]</code>: default Java debug port to use for
Spark workers. A free port is chosen if this port is unavailable.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;executor_debug_port&#39;]</code>: default Java debug port to use for
Spark standalone executors. A free port is chosen if this port is unavailable.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;common_extra_classpath_items&#39;]</code>: common classpath items to
add to Spark application driver and executors (but not Spark master and worker processes).</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_dir&#39;]</code>: Set to a non-nil value to tell the spark worker to use an alternate directory for spark scratch space</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;worker_opts&#39;]</code>: Set to a non-nil value to pass along any additional settings to the spark worker. E.G.: <code>-Dspark.worker.cleanup.enabled=true -Dspark.worker.cleanup.appDataTtl=86400</code>.  Ideal for worker options only that you do not want in the default configuration file.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;conf&#39;][&#39;...&#39;]</code>: Spark configuration options that go into the default
Spark configuration file. See <a href="https://spark.apache.org/docs/latest/configuration.html">https://spark.apache.org/docs/latest/configuration.html</a> for details.</li>
<li><code>node[&#39;apache_spark&#39;][&#39;standalone&#39;][&#39;local_dirs&#39;]</code>: a list of local directories to use on workers.
This is where map output files are stored, so these directories should have enough space
available.</li>
</ul>

<h2>Testing</h2>

<h3>ChefSpec</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_install'>install</span>
<span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_exec'>exec</span> <span class='id identifier rubyid_rspec'>rspec</span>
</code></pre>

<h3>Test Kitchen</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_install'>install</span>
<span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_exec'>exec</span> <span class='id identifier rubyid_kitchen'>kitchen</span> <span class='id identifier rubyid_test'>test</span>
</code></pre>

<h2>Contributing</h2>

<p>If you would like to contribute this cookbook&#39;s development, please follow the steps below:</p>

<ul>
<li>Fork this repository on GitHub</li>
<li>Make your changes</li>
<li>Run tests</li>
<li>Submit a pull request</li>
</ul>

<h2>License</h2>

<p>Apache License 2.0</p>

<p><a href="https://www.apache.org/licenses/LICENSE-2.0">https://www.apache.org/licenses/LICENSE-2.0</a></p>



<h1>Cookbook Documentation</h1>




  <h2>Recipes Summary</h2>
  <ul class="summary">
    
      <li>
        <span class="summary_signature">
          <strong><a href="#apache_spark::spark-user">apache_spark::spark-user</a></strong>
        </span>
        <span class="summary_desc"></span>
      </li>
    
      <li>
        <span class="summary_signature">
          <strong><a href="#apache_spark::spark-install">apache_spark::spark-install</a></strong>
        </span>
        <span class="summary_desc"></span>
      </li>
    
      <li>
        <span class="summary_signature">
          <strong><a href="#apache_spark::find-free-port">apache_spark::find-free-port</a></strong>
        </span>
        <span class="summary_desc"></span>
      </li>
    
      <li>
        <span class="summary_signature">
          <strong><a href="#apache_spark::spark-standalone-worker">apache_spark::spark-standalone-worker</a></strong>
        </span>
        <span class="summary_desc"></span>
      </li>
    
      <li>
        <span class="summary_signature">
          <strong><a href="#apache_spark::spark-standalone-master">apache_spark::spark-standalone-master</a></strong>
        </span>
        <span class="summary_desc"></span>
      </li>
    
      <li>
        <span class="summary_signature">
          <strong><a href="#apache_spark::force-package-index-update">apache_spark::force-package-index-update</a></strong>
        </span>
        <span class="summary_desc"></span>
      </li>
    
  </ul>




















<div class="method_details_list">
  



  <h2>Recipe Details</h2>
  
    <div class="method_details first">
      <h3 class="signature"><a name="apache_spark::spark-user">
        <strong>apache_spark::spark-user</strong>
      </a></h3>
      
      

<table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'recipes/spark-user.rb', line 1</span>

<span class='comment'># Copyright 2015 ClearStory Data, Inc.
</span><span class='comment'>#
</span><span class='comment'># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span class='comment'># you may not use this file except in compliance with the License.
</span><span class='comment'># You may obtain a copy of the License at
</span><span class='comment'>#
</span><span class='comment'>#     http://www.apache.org/licenses/LICENSE-2.0
</span><span class='comment'>#
</span><span class='comment'># Unless required by applicable law or agreed to in writing, software
</span><span class='comment'># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span class='comment'># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class='comment'># See the License for the specific language governing permissions and
</span><span class='comment'># limitations under the License.
</span>
<span class='id identifier rubyid_spark_user'>spark_user</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_spark_group'>spark_group</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>group</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

<span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>

<span class='id identifier rubyid_user'>user</span> <span class='id identifier rubyid_spark_user'>spark_user</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_comment'>comment</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Apache Spark Framework</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_uid'>uid</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uid</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uid</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_gid'>gid</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>

    </div>
  
    <div class="method_details ">
      <h3 class="signature"><a name="apache_spark::spark-install">
        <strong>apache_spark::spark-install</strong>
      </a></h3>
      
      

<table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'recipes/spark-install.rb', line 1</span>

<span class='comment'># Copyright 2015 ClearStory Data, Inc.
</span><span class='comment'>#
</span><span class='comment'># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span class='comment'># you may not use this file except in compliance with the License.
</span><span class='comment'># You may obtain a copy of the License at
</span><span class='comment'>#
</span><span class='comment'>#     http://www.apache.org/licenses/LICENSE-2.0
</span><span class='comment'>#
</span><span class='comment'># Unless required by applicable law or agreed to in writing, software
</span><span class='comment'># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span class='comment'># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class='comment'># See the License for the specific language governing permissions and
</span><span class='comment'># limitations under the License.
</span>
<span class='id identifier rubyid_include_recipe'>include_recipe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark::find-free-port</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_include_recipe'>include_recipe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark::spark-user</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_spark_user'>spark_user</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_spark_group'>spark_group</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>group</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

<span class='id identifier rubyid_install_mode'>install_mode</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_mode</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

<span class='id identifier rubyid_spark_install_dir'>spark_install_dir</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_spark_install_base_dir'>spark_install_base_dir</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_base_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_spark_conf_dir'>spark_conf_dir</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_spark_install_dir'>spark_install_dir</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>conf</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

<span class='kw'>case</span> <span class='id identifier rubyid_install_mode'>install_mode</span>
<span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>package</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_package'>package</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pkg_name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_version'>version</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pkg_version</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>tarball</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_install_base_dir'>install_base_dir</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_base_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_directory'>directory</span> <span class='id identifier rubyid_install_base_dir'>install_base_dir</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_user'>user</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
    <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_tarball_basename'>tarball_basename</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='const'>URI</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>download_url</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_downloaded_tarball_path'>downloaded_tarball_path</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='const'>Chef</span><span class='op'>::</span><span class='const'>Config</span><span class='lbracket'>[</span><span class='symbol'>:file_cache_path</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_tarball_basename'>tarball_basename</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_tarball_url'>tarball_url</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>download_url</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='const'>Chef</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tarball_url'>tarball_url</span><span class='embexpr_end'>}</span><span class='tstring_content'> will be downloaded to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_downloaded_tarball_path'>downloaded_tarball_path</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_remote_file'>remote_file</span> <span class='id identifier rubyid_downloaded_tarball_path'>downloaded_tarball_path</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_source'>source</span> <span class='id identifier rubyid_tarball_url'>tarball_url</span>
    <span class='id identifier rubyid_checksum'>checksum</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>checksum</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_extracted_dir_name'>extracted_dir_name</span> <span class='op'>=</span> <span class='id identifier rubyid_tarball_basename'>tarball_basename</span><span class='period'>.</span><span class='id identifier rubyid_sub'>sub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[.](tar[.]gz|tgz)$</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='const'>Chef</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_downloaded_tarball_path'>downloaded_tarball_path</span><span class='embexpr_end'>}</span><span class='tstring_content'> will be extracted in </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_install_base_dir'>install_base_dir</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_actual_install_dir'>actual_install_dir</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_install_base_dir'>install_base_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_extracted_dir_name'>extracted_dir_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_tar_extract'>tar_extract</span> <span class='id identifier rubyid_downloaded_tarball_path'>downloaded_tarball_path</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_action'>action</span> <span class='symbol'>:extract_local</span>
    <span class='id identifier rubyid_target_dir'>target_dir</span> <span class='id identifier rubyid_install_base_dir'>install_base_dir</span>
    <span class='id identifier rubyid_creates'>creates</span> <span class='id identifier rubyid_actual_install_dir'>actual_install_dir</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_link'>link</span> <span class='id identifier rubyid_spark_install_dir'>spark_install_dir</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_actual_install_dir'>actual_install_dir</span>
    <span class='id identifier rubyid_user'>user</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
    <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='kw'>end</span>
<span class='kw'>else</span>
  <span class='id identifier rubyid_fail'>fail</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid Apache Spark installation mode: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_install_mode'>install_mode</span><span class='embexpr_end'>}</span><span class='tstring_content'>. &#39;package&#39; or &#39;tarball&#39; required.</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_local_dirs'>local_dirs</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>local_dirs</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

<span class='lparen'>(</span>
  <span class='lbracket'>[</span>
    <span class='id identifier rubyid_spark_install_dir'>spark_install_dir</span><span class='comma'>,</span>
    <span class='id identifier rubyid_spark_conf_dir'>spark_conf_dir</span><span class='comma'>,</span>
    <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>log_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>worker_work_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='rbracket'>]</span> <span class='op'>+</span> <span class='id identifier rubyid_local_dirs'>local_dirs</span>
<span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_dir'>dir</span><span class='op'>|</span>
  <span class='id identifier rubyid_directory'>directory</span> <span class='id identifier rubyid_dir'>dir</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0755</span>
    <span class='id identifier rubyid_owner'>owner</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
    <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
    <span class='id identifier rubyid_action'>action</span> <span class='symbol'>:create</span>
    <span class='id identifier rubyid_recursive'>recursive</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_template'>template</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spark_conf_dir'>spark_conf_dir</span><span class='embexpr_end'>}</span><span class='tstring_content'>/spark-env.sh</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark-env.sh.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0644</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
  <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='id identifier rubyid_variables'>variables</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_bash'>bash</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Change ownership of Spark installation directory</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_user'>user</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_code'>code</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>chown -R </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spark_user'>spark_user</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spark_group'>spark_group</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spark_install_base_dir'>spark_install_base_dir</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_template'>template</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spark_conf_dir'>spark_conf_dir</span><span class='embexpr_end'>}</span><span class='tstring_content'>/log4j.properties</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark_log4j.properties.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0644</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
  <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='id identifier rubyid_variables'>variables</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_common_extra_classpath_items_str'>common_extra_classpath_items_str</span> <span class='op'>=</span>
  <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>common_extra_classpath_items</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

<span class='id identifier rubyid_default_executor_mem_mb'>default_executor_mem_mb</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>default_executor_mem_mb</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

<span class='id identifier rubyid_template'>template</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spark_conf_dir'>spark_conf_dir</span><span class='embexpr_end'>}</span><span class='tstring_content'>/spark-defaults.conf</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark-defaults.conf.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0644</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
  <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='id identifier rubyid_variables'>variables</span> <span class='label'>options:</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>conf</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark.driver.extraClassPath</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_common_extra_classpath_items_str'>common_extra_classpath_items_str</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark.executor.extraClassPath</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_common_extra_classpath_items_str'>common_extra_classpath_items_str</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark.executor.memory</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_default_executor_mem_mb'>default_executor_mem_mb</span><span class='embexpr_end'>}</span><span class='tstring_content'>m</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark.local.dir</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_local_dirs'>local_dirs</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>,</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>

    </div>
  
    <div class="method_details ">
      <h3 class="signature"><a name="apache_spark::find-free-port">
        <strong>apache_spark::find-free-port</strong>
      </a></h3>
      
      

<table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'recipes/find-free-port.rb', line 1</span>

<span class='comment'># Copyright 2015 ClearStory Data, Inc.
</span><span class='comment'>#
</span><span class='comment'># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span class='comment'># you may not use this file except in compliance with the License.
</span><span class='comment'># You may obtain a copy of the License at
</span><span class='comment'>#
</span><span class='comment'>#     http://www.apache.org/licenses/LICENSE-2.0
</span><span class='comment'>#
</span><span class='comment'># Unless required by applicable law or agreed to in writing, software
</span><span class='comment'># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span class='comment'># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class='comment'># See the License for the specific language governing permissions and
</span><span class='comment'># limitations under the License.
</span>
<span class='id identifier rubyid_template'>template</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/usr/local/bin/find-free-port.rb</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>find-free-port.rb.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0755</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_group'>group</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_variables'>variables</span> <span class='label'>ruby_interpreter:</span> <span class='const'>RbConfig</span><span class='period'>.</span><span class='id identifier rubyid_ruby'>ruby</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>

    </div>
  
    <div class="method_details ">
      <h3 class="signature"><a name="apache_spark::spark-standalone-worker">
        <strong>apache_spark::spark-standalone-worker</strong>
      </a></h3>
      
      

<table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'recipes/spark-standalone-worker.rb', line 1</span>

<span class='comment'># Copyright 2015 ClearStory Data, Inc.
</span><span class='comment'>#
</span><span class='comment'># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span class='comment'># you may not use this file except in compliance with the License.
</span><span class='comment'># You may obtain a copy of the License at
</span><span class='comment'>#
</span><span class='comment'>#     http://www.apache.org/licenses/LICENSE-2.0
</span><span class='comment'>#
</span><span class='comment'># Unless required by applicable law or agreed to in writing, software
</span><span class='comment'># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span class='comment'># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class='comment'># See the License for the specific language governing permissions and
</span><span class='comment'># limitations under the License.
</span>
<span class='id identifier rubyid_include_recipe'>include_recipe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark::spark-install</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_include_recipe'>include_recipe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>monit_wrapper</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_worker_runner_script'>worker_runner_script</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>worker_runner.sh</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

<span class='id identifier rubyid_spark_user'>spark_user</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_spark_group'>spark_group</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>group</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

<span class='id identifier rubyid_template'>template</span> <span class='id identifier rubyid_worker_runner_script'>worker_runner_script</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark_worker_runner.sh.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0744</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
  <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='id identifier rubyid_variables'>variables</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span>
    <span class='label'>install_dir:</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>user:</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
  <span class='rparen'>)</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_directory'>directory</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>worker_work_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0755</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
  <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='id identifier rubyid_action'>action</span> <span class='symbol'>:create</span>
  <span class='id identifier rubyid_recursive'>recursive</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_template'>template</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/usr/local/bin/clean_spark_worker_dir.rb</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>clean_spark_worker_dir.rb.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0755</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_group'>group</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_variables'>variables</span> <span class='label'>ruby_interpreter:</span> <span class='const'>RbConfig</span><span class='period'>.</span><span class='id identifier rubyid_ruby'>ruby</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_worker_dir_cleanup_log'>worker_dir_cleanup_log</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>worker_dir_cleanup_log</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_cron'>cron</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>clean_spark_worker_dir</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_minute'>minute</span> <span class='int'>15</span>
  <span class='id identifier rubyid_hour'>hour</span> <span class='int'>0</span>
  <span class='id identifier rubyid_command'>command</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/usr/local/bin/clean_spark_worker_dir.rb </span><span class='tstring_end'>&#39;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--worker_dir </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>worker_work_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--days_retained </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>job_dir_days_retained</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--num_retained </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>job_dir_num_retained</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&amp;&gt;&gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_worker_dir_cleanup_log'>worker_dir_cleanup_log</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='comment'># logrotate for the log cleanup script
</span><span class='id identifier rubyid_logrotate_app'>logrotate_app</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>worker-dir-cleanup-log</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_cookbook'>cookbook</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>logrotate</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_path'>path</span> <span class='id identifier rubyid_worker_dir_cleanup_log'>worker_dir_cleanup_log</span>
  <span class='id identifier rubyid_frequency'>frequency</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>daily</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_rotate'>rotate</span> <span class='int'>3</span>  <span class='comment'># keep this many logs
</span>  <span class='id identifier rubyid_create'>create</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0644 root root</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='comment'># Run Spark standalone worker with Monit
</span><span class='id identifier rubyid_service_name'>service_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark-standalone-worker</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_master_host_port'>master_host_port</span> <span class='op'>=</span> <span class='id identifier rubyid_format'>format</span><span class='lparen'>(</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%s:%d</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>master_host</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
  <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>master_port</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
<span class='rparen'>)</span>

<span class='id identifier rubyid_monit_wrapper_monitor'>monit_wrapper_monitor</span> <span class='id identifier rubyid_service_name'>service_name</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_template_source'>template_source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pattern-based_service.conf.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_template_cookbook'>template_cookbook</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>monit_wrapper</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_wait_for_host_port'>wait_for_host_port</span> <span class='id identifier rubyid_master_host_port'>master_host_port</span>
  <span class='id identifier rubyid_variables'>variables</span> \
    <span class='label'>cmd_line_pattern:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>^(/\S+/)?java.* org\.apache\.spark\.deploy\.worker\.Worker </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='label'>cmd_line:</span> <span class='id identifier rubyid_worker_runner_script'>worker_runner_script</span><span class='comma'>,</span>
    <span class='label'>user:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>  <span class='comment'># The worker needs to run as root initially to use ulimit.
</span>    <span class='label'>group:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>root</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_monit_wrapper_service'>monit_wrapper_service</span> <span class='id identifier rubyid_service_name'>service_name</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_action'>action</span> <span class='symbol'>:start</span>
  <span class='id identifier rubyid_wait_for_host_port'>wait_for_host_port</span> <span class='id identifier rubyid_master_host_port'>master_host_port</span>

  <span class='comment'># Determine the &quot;notification action&quot; based on whether the service is running at recipe compile
</span>  <span class='comment'># time. This is important because if the service is not running when the Chef run starts, it will
</span>  <span class='comment'># start as part of the :start action and pick up the new software version and configuration
</span>  <span class='comment'># anyway, so we don&#39;t have to restart it as part of delayed notification.
</span>  <span class='comment'># TODO: put this logic in a library method in monit_wrapper.
</span>  <span class='id identifier rubyid_notification_action'>notification_action</span> <span class='op'>=</span> <span class='id identifier rubyid_monit_service_exists_and_running?'>monit_service_exists_and_running?</span><span class='lparen'>(</span><span class='id identifier rubyid_service_name'>service_name</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='symbol'>:restart</span> <span class='op'>:</span> <span class='symbol'>:start</span>

  <span class='id identifier rubyid_subscribes'>subscribes</span> <span class='id identifier rubyid_notification_action'>notification_action</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>monit-wrapper_monitor[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_service_name'>service_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:delayed</span>
  <span class='id identifier rubyid_subscribes'>subscribes</span> <span class='id identifier rubyid_notification_action'>notification_action</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>package[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pkg_name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:delayed</span>
  <span class='id identifier rubyid_subscribes'>subscribes</span> <span class='id identifier rubyid_notification_action'>notification_action</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>template[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_worker_runner_script'>worker_runner_script</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:delayed</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>

    </div>
  
    <div class="method_details ">
      <h3 class="signature"><a name="apache_spark::spark-standalone-master">
        <strong>apache_spark::spark-standalone-master</strong>
      </a></h3>
      
      

<table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'recipes/spark-standalone-master.rb', line 1</span>

<span class='comment'># Copyright 2015 ClearStory Data, Inc.
</span><span class='comment'>#
</span><span class='comment'># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span class='comment'># you may not use this file except in compliance with the License.
</span><span class='comment'># You may obtain a copy of the License at
</span><span class='comment'>#
</span><span class='comment'>#     http://www.apache.org/licenses/LICENSE-2.0
</span><span class='comment'>#
</span><span class='comment'># Unless required by applicable law or agreed to in writing, software
</span><span class='comment'># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span class='comment'># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class='comment'># See the License for the specific language governing permissions and
</span><span class='comment'># limitations under the License.
</span>
<span class='id identifier rubyid_include_recipe'>include_recipe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark::spark-install</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_include_recipe'>include_recipe</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>monit_wrapper</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_master_runner_script'>master_runner_script</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bin</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>master_runner.sh</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

<span class='id identifier rubyid_spark_user'>spark_user</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_spark_group'>spark_group</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>group</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

<span class='id identifier rubyid_template'>template</span> <span class='id identifier rubyid_master_runner_script'>master_runner_script</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark_master_runner.sh.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_mode'>mode</span> <span class='int'>0744</span>
  <span class='id identifier rubyid_owner'>owner</span> <span class='id identifier rubyid_spark_user'>spark_user</span>
  <span class='id identifier rubyid_group'>group</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
  <span class='id identifier rubyid_variables'>variables</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>standalone</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span>
    <span class='label'>install_dir:</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>install_dir</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='rparen'>)</span>
<span class='kw'>end</span>

<span class='comment'># Run Spark standalone master with Monit
</span><span class='id identifier rubyid_service_name'>service_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spark-standalone-master</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_monit_wrapper_monitor'>monit_wrapper_monitor</span> <span class='id identifier rubyid_service_name'>service_name</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_template_source'>template_source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pattern-based_service.conf.erb</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_template_cookbook'>template_cookbook</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>monit_wrapper</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_variables'>variables</span> \
    <span class='label'>cmd_line_pattern:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>^(/\S+/)?java.* (org\.apache\.)?spark\.deploy\.master\.Master </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='label'>cmd_line:</span> <span class='id identifier rubyid_master_runner_script'>master_runner_script</span><span class='comma'>,</span>
    <span class='label'>user:</span> <span class='id identifier rubyid_spark_user'>spark_user</span><span class='comma'>,</span>
    <span class='label'>group:</span> <span class='id identifier rubyid_spark_group'>spark_group</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_monit_wrapper_service'>monit_wrapper_service</span> <span class='id identifier rubyid_service_name'>service_name</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_action'>action</span> <span class='symbol'>:start</span>

  <span class='comment'># Determine the &quot;notification action&quot; based on whether the service is running at recipe compile
</span>  <span class='comment'># time. This is important because if the service is not running when the Chef run starts, it will
</span>  <span class='comment'># start as part of the :start action and pick up the new software version and configuration
</span>  <span class='comment'># anyway, so we don&#39;t have to restart it as part of delayed notification.
</span>  <span class='comment'># TODO: put this logic in a library method in monit_wrapper.
</span>  <span class='id identifier rubyid_notification_action'>notification_action</span> <span class='op'>=</span> <span class='id identifier rubyid_monit_service_exists_and_running?'>monit_service_exists_and_running?</span><span class='lparen'>(</span><span class='id identifier rubyid_service_name'>service_name</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='symbol'>:restart</span> <span class='op'>:</span> <span class='symbol'>:start</span>

  <span class='id identifier rubyid_subscribes'>subscribes</span> <span class='id identifier rubyid_notification_action'>notification_action</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>monit-wrapper_monitor[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_service_name'>service_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:delayed</span>
  <span class='id identifier rubyid_subscribes'>subscribes</span> <span class='id identifier rubyid_notification_action'>notification_action</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>package[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apache_spark</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>pkg_name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:delayed</span>
  <span class='id identifier rubyid_subscribes'>subscribes</span> <span class='id identifier rubyid_notification_action'>notification_action</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>template[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_master_runner_script'>master_runner_script</span><span class='embexpr_end'>}</span><span class='tstring_content'>]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:delayed</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>

    </div>
  
    <div class="method_details ">
      <h3 class="signature"><a name="apache_spark::force-package-index-update">
        <strong>apache_spark::force-package-index-update</strong>
      </a></h3>
      
      

<table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'recipes/force-package-index-update.rb', line 1</span>

<span class='comment'># Copyright 2015 ClearStory Data, Inc.
</span><span class='comment'>#
</span><span class='comment'># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span class='comment'># you may not use this file except in compliance with the License.
</span><span class='comment'># You may obtain a copy of the License at
</span><span class='comment'>#
</span><span class='comment'>#     http://www.apache.org/licenses/LICENSE-2.0
</span><span class='comment'>#
</span><span class='comment'># Unless required by applicable law or agreed to in writing, software
</span><span class='comment'># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span class='comment'># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class='comment'># See the License for the specific language governing permissions and
</span><span class='comment'># limitations under the License.
</span>
<span class='kw'>case</span> <span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>platform</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>debian</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ubuntu</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_execute'>execute</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apt-get update</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_command'>command</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apt-get update</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_action'>action</span> <span class='symbol'>:nothing</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_run_action'>run_action</span><span class='lparen'>(</span><span class='symbol'>:run</span><span class='rparen'>)</span>
<span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>redhat</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>centos</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fedora</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_execute'>execute</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>apt-get update</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_command'>command</span> <span class='heredoc_beg'>&lt;&lt;-EOT</span>
<span class='tstring_content'>      yum check-update
      exit_code=$?
      if [ &quot;${exit_code}&quot; -eq 100 ]; then
        # yum returns 100 when there are updates available.
        exit_code=0
      fi
      exit &quot;${exit_code}&quot;
</span><span class='heredoc_end'>    EOT
</span>    <span class='id identifier rubyid_action'>action</span> <span class='symbol'>:nothing</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_run_action'>run_action</span><span class='lparen'>(</span><span class='symbol'>:run</span><span class='rparen'>)</span>
<span class='kw'>else</span>
  <span class='const'>Chef</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot update package index for platform </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_node'>node</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>platform</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> -- doing nothing</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>

    </div>
  









</div>


</div>
</div>

    <div id="footer">
  Generated on Tue Jan  5 18:27:43 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.7).
</div>

  </body>
</html>